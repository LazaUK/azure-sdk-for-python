parameters:
  - name: CondaArtifacts
    type: object
    default: []
  - name: ArtifactPrefix
    type: string
    default: ''
  - name: Arguments
    type: string
    default: ''

steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python $(PythonVersion)'
    inputs:
      versionSpec: $(PythonVersion)

  - pwsh: |
      $ErrorActionPreference = 'Stop'
      $PSNativeCommandUseErrorActionPreference = $true
      pip install "tools/azure-sdk-tools[build,conda]"
      pip install disutils
    displayName: Install build script requirements


  - pwsh: |
      $argument = @'
        ${{ replace(convertToJson(parameters.CondaArtifacts), '"', '\"') }}
      '@
      $escapedJsonString = $argument -replace "`r`n", "" -replace "\s", ""
      Write-Host "##vso[task.setvariable variable=conda_artifact_arg;]$escapedJsonString"
      Write-Host "$escapedJsonString"
    displayName: "Convert YAML to JSON-like string"

  - pwsh: |
      Write-Host "$(conda_artifact_arg)"
      sdk_build_conda -c "$(conda_artifact_arg)" ${{ parameters.Arguments }}
    displayName: Assemble Conda Packages
  
  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/assembled'
      ArtifactName: '${{ parameters.ArtifactPrefix }}distributions'

  - ${{if eq(variables['System.TeamProject'], 'internal') }}:
    - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
      displayName: 'Upload Conda SBOM'
      condition: succeededOrFailed()
      inputs:
        BuildDropPath: '$(Build.SourcesDirectory)/conda/output'

  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/output'
      ArtifactName: '${{ parameters.ArtifactPrefix }}conda'
