parameters:
  - name: ServiceDirectory
    type: string
    default: not-specified
  - name: Artifacts
    type: object
    default: []
  - name: TestPipeline
    type: boolean
    default: false
  - name: BeforeTestSteps
    type: object
    default: []
  - name: AfterTestSteps
    type: object
    default: []
  - name: BeforePublishSteps
    type: object
    default: []
  - name: TestMarkArgument
    type: string
    default: ''
  - name: BuildTargetingString
    type: string
    default: azure-*
  - name: TestTimeoutInMinutes
    type: number
    default: 60
  - name: ToxEnvParallel
    type: string
    default: --tenvparallel
  - name: InjectedPackages
    type: string
    default: ''
  - name: BuildDocs
    type: boolean
    default: true
  - name: DevFeedName
    type: string
    default: public/azure-sdk-for-python
  - name: TargetDocRepoOwner
    type: string
    default: MicrosoftDocs
  - name: TargetDocRepoName
    type: string
    default: azure-docs-sdk-python
  - name: MatrixConfigs
    type: object
    default:
      - Name: Python_ci_test_base
        Path: eng/pipelines/templates/stages/platform-matrix.json
        Selection: sparse
        GenerateVMJobs: true
  - name: AdditionalMatrixConfigs
    type: object
    default: []
  - name: MatrixFilters
    type: object
    default: []
  - name: MatrixReplace
    type: object
    default: []
  - name: VerifyAutorest
    type: boolean
    default: false
  - name: ValidateFormatting
    type: boolean
    default: false
  - name: TestProxy
    type: boolean
    default: false
  - name: GenerateApiReviewForManualOnly
    type: boolean
    default: false
  - name: AdvancedBuild
    type: boolean
    default: false

resources:
  repositories:
    - repository: self
      type: git
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  ${{ if eq(variables['System.TeamProject'], 'internal') }}:
    template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  ${{ else }}:
    template: v1/1ES.Unofficial.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    ${{ if eq(variables['System.TeamProject'], 'internal') }}:
      sdl:
        sourceAnalysisPool:
          name: azsdk-pool-mms-win-2022-1es-pt
          image: azsdk-pool-mms-win-2022-1espt
          os: windows
    stages:

      - stage: Build
        variables:
          BuildId: $(Build.BuildId)
          system.debug: true
          REPOROOT: $(Build.SourcesDirectory)
          WINDOWS_OUTPUTROOT: $(REPOROOT)\out
          WindowsContainerImage: 'onebranch.azurecr.io/windows/ltsc2019/vse2022:latest'

        jobs:
        # - job: 'Build'
        #   timeoutInMinutes: 90

        #   pool:
        #     name: azsdk-pool-mms-ubuntu-2004-1es-pt
        #     vmImage: azsdk-pool-mms-ubuntu-2004-1espt
        #     os: linux

        #   steps:
        #   - pwsh: |
        #       Get-ChildItem -Path $(Build.SourcesDirectory) -Recurse | ForEach-Object {
        #         Write-Host $_.FullName
        #       }
        #     displayName: WHAT IS HAPPENING

          - template: eng/pipelines/templates/jobs/ci.yml
            parameters:
              ServiceDirectory: ${{ parameters.ServiceDirectory }}
              Artifacts: ${{ parameters.Artifacts }}
              ${{ if eq(parameters.ServiceDirectory, 'template') }}:
                TestPipeline: true
              BeforeTestSteps: ${{ parameters.BeforeTestSteps }}
              AfterTestSteps: ${{ parameters.AfterTestSteps }}
              BeforePublishSteps: ${{ parameters.BeforePublishSteps }}
              TestMarkArgument: ${{ parameters.TestMarkArgument }}
              BuildTargetingString: ${{ parameters.BuildTargetingString }}'
              TestTimeoutInMinutes: ${{ parameters.TestTimeoutInMinutes }}
              ToxEnvParallel: ${{ parameters.ToxEnvParallel }}
              InjectedPackages: ${{ parameters.InjectedPackages }}
              BuildDocs: ${{ parameters.BuildDocs }}
              DevFeedName: ${{ parameters.DevFeedName }}
              MatrixConfigs:
                - ${{ each config in parameters.MatrixConfigs }}:
                    - ${{ config }}
                - ${{ each config in parameters.AdditionalMatrixConfigs }}:
                    - ${{ config }}
              MatrixFilters: ${{ parameters.MatrixFilters }}
              MatrixReplace: ${{ parameters.MatrixReplace }}
              VerifyAutorest: ${{ parameters.VerifyAutorest }}
              ValidateFormatting: ${{ parameters.ValidateFormatting }}
              TestProxy: ${{ parameters.TestProxy }}
              GenerateApiReviewForManualOnly: ${{ parameters.GenerateApiReviewForManualOnly }}
              AdvancedBuild: ${{ parameters.AdvancedBuild }}

      # The Prerelease and Release stages are conditioned on whether we are building a pull request and the branch.
      # - ${{if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal'))}}:
      #     - template: archetype-python-release.yml
      #       parameters:
      #         DependsOn: Build
      #         ServiceDirectory: ${{ parameters.ServiceDirectory }}
      #         Artifacts: ${{ parameters.Artifacts }}
      #         ${{ if eq(parameters.ServiceDirectory, 'template') }}:
      #           TestPipeline: true
      #         ArtifactName: packages_extended
      #         DocArtifact: documentation
      #         TargetDocRepoOwner: ${{ parameters.TargetDocRepoOwner }}
      #         TargetDocRepoName: ${{ parameters.TargetDocRepoName }}
      #         DevFeedName: ${{ parameters.DevFeedName }}


